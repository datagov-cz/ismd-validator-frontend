name: Trigger Deployment

on:
  # Triggered when a new image is published
  workflow_run:
    workflows: [Build Docker on Main, Build Docker on Dev]
    types: [completed]
    branches: [main, dev]
  # Receive completion signal from the infrastructure repo
  repository_dispatch:
    types: [infra-deploy-complete]
  
  # Manual trigger with environment and version selection
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - test
          - prod
        default: 'dev'
      version:
        description: 'Image version to deploy (leave empty for latest)'
        required: false
        type: string

permissions:
  contents: read
  deployments: write
env:
  INFRA_REPO: ${{ github.repository_owner }}/ismd-infrastructure
  COMPONENT_NAME: frontend

jobs:
  determine-params:
    name: Determine Deployment Parameters
    runs-on: ubuntu-latest
    # Only run if this is a workflow_dispatch or workflow_run event with successful conclusion
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
    outputs:
      environment: ${{ steps.determine_params.outputs.environment }}
      image_tag: ${{ steps.determine_params.outputs.image_tag }}
      repo_name: ${{ steps.determine_params.outputs.repo_name }}
      workflow_run_id: ${{ steps.determine_params.outputs.workflow_run_id }}
      ref: ${{ steps.determine_params.outputs.ref }}
      pr_url: ${{ steps.resolve_pr.outputs.pr_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          # For workflow_run, check out the exact commit that built the image; otherwise use the current SHA
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}
          fetch-depth: 0  # Fetch all history including tags
      
      - name: Determine environment and version
        id: determine_params
        run: |
          # For manual triggers, use the specified environment
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENVIRONMENT="${{ github.event.inputs.environment }}"
            ENVIRONMENT="${ENVIRONMENT^^}" # Convert to uppercase
            
            # If version is specified, use it
            if [ -n "${{ github.event.inputs.version }}" ]; then
              IMAGE_TAG="${{ github.event.inputs.version }}"
            else
              # Query GitHub Packages API for the latest available image tag
              REPO_OWNER='${{ github.repository_owner }}'
              
              # Determine package name based on environment
              if [ "$ENVIRONMENT" = "DEV" ]; then
                PACKAGE_NAME="ismd-validator-frontend-dev"
              else
                PACKAGE_NAME="ismd-validator-frontend"
              fi
              
              echo "Querying GitHub Packages API for latest image in ${PACKAGE_NAME}..."
              
              # Get all versions from GitHub Packages API, extract tags, filter and sort
              LATEST_TAG=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "https://api.github.com/orgs/${REPO_OWNER}/packages/container/${PACKAGE_NAME}/versions?per_page=100" 2>/dev/null | \
                jq -r '.[].metadata.container.tags[]?' 2>/dev/null | \
                grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9-]+)?$' | \
                sort -V | tail -1)
              
              if [ -n "$LATEST_TAG" ]; then
                IMAGE_TAG="$LATEST_TAG"
                echo "Using latest available image from registry: $IMAGE_TAG"
              else
                # Fallback: construct version from Git tag
                echo "Could not fetch tags from registry, falling back to Git tag"
                TAG=$(git describe --tags --abbrev=0 --match "v[0-9]*" 2>/dev/null || echo "")
                if [ -z "$TAG" ]; then
                  BASE_VERSION="0.1.0"
                  echo "No tags found, using default version: $BASE_VERSION"
                else
                  BASE_VERSION=$(echo "$TAG" | sed 's/^v//')
                  echo "Found tag: $TAG, using version: $BASE_VERSION"
                fi
                IMAGE_TAG="$BASE_VERSION"
                
                # For manual DEV, append short SHA
                if [ "$ENVIRONMENT" = "DEV" ]; then
                  SHORT_SHA=${GITHUB_SHA:0:7}
                  IMAGE_TAG="${IMAGE_TAG}-${SHORT_SHA}"
                fi
              fi
            fi
          else
            # For automated triggers (workflow_run), determine environment from branch
            if [ "${{ github.event.workflow_run.head_branch }}" == "main" ]; then
              ENVIRONMENT="TEST"
            else
              ENVIRONMENT="DEV"
            fi
            
            # Get version from latest Git tag (same as build workflow)
            TAG=$(git describe --tags --abbrev=0 --match "v[0-9]*" 2>/dev/null || echo "")
            if [ -z "$TAG" ]; then
              BASE_VERSION="0.1.0"
              echo "No tags found, using default version: $BASE_VERSION"
            else
              BASE_VERSION=$(echo "$TAG" | sed 's/^v//')
              echo "Found tag: $TAG, using version: $BASE_VERSION"
            fi
            IMAGE_TAG="$BASE_VERSION"
            
            # For dev branch, append the short SHA
            if [ "${{ github.event.workflow_run.head_branch }}" == "dev" ]; then
              SHORT_SHA=$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)
              IMAGE_TAG="${IMAGE_TAG}-${SHORT_SHA}"
            fi
          fi
          
          # Determine the correct ref for the deployment
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            REF="${{ github.event.workflow_run.head_sha }}"
          else
            REF="${GITHUB_SHA}"
          fi
          
          # Safe workflow_run_id extraction
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            WORKFLOW_RUN_ID="${{ github.event.workflow_run.id }}"
          else
            WORKFLOW_RUN_ID=""
          fi
          
          # Set the correct repository name based on environment
          # Only dev images have environment suffix, test/prod use base image name
          if [ "${ENVIRONMENT}" == "DEV" ]; then
            REPO_NAME="ismd-validator-frontend-dev"
          else
            REPO_NAME="ismd-validator-frontend"
          fi
          
          echo "ENVIRONMENT=${ENVIRONMENT}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
          echo "REPO_NAME=${REPO_NAME}" >> $GITHUB_ENV
          echo "Environment: ${ENVIRONMENT}"
          echo "Image tag: ${IMAGE_TAG}"
          echo "Repository: ${REPO_NAME}"
          echo "ref=${REF}" >> $GITHUB_OUTPUT
          echo "Workflow Run ID: ${WORKFLOW_RUN_ID}"
          
          # Set outputs for later steps
          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "repo_name=${REPO_NAME}" >> $GITHUB_OUTPUT
          echo "workflow_run_id=${WORKFLOW_RUN_ID}" >> $GITHUB_OUTPUT
          echo "ref=${REF}" >> $GITHUB_OUTPUT

      - name: Resolve PR URL for ref
        id: resolve_pr
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = `${{ steps.determine_params.outputs.ref }}`;
            let prUrl = '';
            try {
              const resp = await github.rest.repos.listPullRequestsAssociatedWithCommit({ owner, repo, commit_sha: sha });
              if (resp.data && resp.data.length > 0) {
                prUrl = resp.data[0].html_url;
              }
            } catch (e) {
              core.info(`No PR found for commit ${sha}: ${e.message}`);
            }
            core.setOutput('pr_url', prUrl);

  # Finalize the GitHub Deployment when infra reports completion
  finalize-deployment:
    name: Finalize Deployment Status
    runs-on: ubuntu-latest
    if: github.event_name == 'repository_dispatch' && github.event.action == 'infra-deploy-complete'
    steps:
      - name: Compose deployment URLs
        id: urls
        run: |
          ENV="${{ github.event.client_payload.environment }}"
          DEV_HOST="${{ vars.DEV_HOSTNAME }}"
          TEST_HOST="${{ vars.TEST_HOSTNAME }}"
          PROD_HOST="${{ vars.PROD_HOSTNAME }}"
          PUB_URL=""
          if [ "$ENV" = "dev" ] && [ -n "$DEV_HOST" ]; then PUB_URL="https://${DEV_HOST}"; fi
          if [ "$ENV" = "test" ] && [ -n "$TEST_HOST" ]; then PUB_URL="https://${TEST_HOST}"; fi
          if [ "$ENV" = "prod" ] && [ -n "$PROD_HOST" ]; then PUB_URL="https://${PROD_HOST}"; fi
          PR_URL="${{ github.event.client_payload.pr_url }}"
          LOG_URL="${{ github.event.client_payload.source_run_url }}"
          if [ -z "$LOG_URL" ]; then LOG_URL="${{ github.event.client_payload.infra_run_url }}"; fi
          # Prefer PR URL if available; else fall back to public app URL
          if [ -n "$PR_URL" ]; then echo "environment_url=$PR_URL" >> $GITHUB_OUTPUT; else echo "environment_url=$PUB_URL" >> $GITHUB_OUTPUT; fi
          echo "log_url=$LOG_URL" >> $GITHUB_OUTPUT

      - name: Update Deployment Status (final)
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ github.token }}
          deployment-id: ${{ github.event.client_payload.deployment_id }}
          state: ${{ github.event.client_payload.state }}
          description: Deployment completed
          log-url: ${{ steps.urls.outputs.log_url }}
          environment-url: ${{ steps.urls.outputs.environment_url }}

  # Deploy to dev environment
  deploy-to-dev:
    name: Deploy to Dev
    needs: determine-params
    if: needs.determine-params.outputs.environment == 'DEV'
    runs-on: ubuntu-latest
    environment:
      name: DEV
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Create GitHub Deployment
        id: create_deployment
        uses: chrnorm/deployment-action@v2
        with:
          token: ${{ github.token }}
          environment: DEV
          ref: ${{ needs.determine-params.outputs.ref }}
          description: 'Deployment of ${{ env.COMPONENT_NAME }} image ${{ needs.determine-params.outputs.image_tag }} to DEV'
          auto-merge: false
          payload: |
            {
              "image_tag": "${{ needs.determine-params.outputs.image_tag }}",
              "component": "${{ env.COMPONENT_NAME }}",
              "triggered_by": "${{ github.actor }}",
              "timestamp": "${{ github.event.repository.updated_at }}",
              "workflow_run_id": "${{ needs.determine-params.outputs.workflow_run_id }}"
            }

      - name: Update Deployment Status
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ github.token }}
          deployment-id: ${{ steps.create_deployment.outputs.deployment_id }}
          state: "pending"
          description: "Preparing to deploy"
      
      - name: Trigger Infrastructure Deployment
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.INFRA_REPO_TOKEN }}
          repository: ${{ env.INFRA_REPO }}
          event-type: new-image-dev
          client-payload: |
            {
              "component": "${{ env.COMPONENT_NAME }}",
              "image_tag": "${{ needs.determine-params.outputs.image_tag }}",
              "repo_name": "${{ needs.determine-params.outputs.repo_name }}",
              "source_repo": "${{ github.repository }}",
              "source_deployment_id": "${{ steps.create_deployment.outputs.deployment_id }}",
              "source_run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "pr_url": "${{ needs.determine-params.outputs.pr_url }}"
            }
      
      - name: Update Deployment Status
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ github.token }}
          deployment-id: ${{ steps.create_deployment.outputs.deployment_id }}
          state: "in_progress"
          description: "Deployment triggered in infrastructure repository"
  
  # Deploy to test environment
  deploy-to-test:
    name: Deploy to Test
    needs: determine-params
    if: needs.determine-params.outputs.environment == 'TEST'
    runs-on: ubuntu-latest
    environment:
      name: TEST
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Create GitHub Deployment
        id: create_deployment
        uses: chrnorm/deployment-action@v2
        with:
          token: ${{ github.token }}
          environment: TEST
          ref: ${{ needs.determine-params.outputs.ref }}
          description: 'Deployment of ${{ env.COMPONENT_NAME }} image ${{ needs.determine-params.outputs.image_tag }} to TEST'
          auto-merge: false
          payload: |
            {
              "image_tag": "${{ needs.determine-params.outputs.image_tag }}",
              "component": "${{ env.COMPONENT_NAME }}",
              "triggered_by": "${{ github.actor }}",
              "timestamp": "${{ github.event.repository.updated_at }}",
              "workflow_run_id": "${{ needs.determine-params.outputs.workflow_run_id }}"
            }

      - name: Update Deployment Status
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ github.token }}
          deployment-id: ${{ steps.create_deployment.outputs.deployment_id }}
          state: "pending"
          description: "Preparing to deploy"
      
      - name: Trigger Infrastructure Deployment
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.INFRA_REPO_TOKEN }}
          repository: ${{ env.INFRA_REPO }}
          event-type: new-image-test
          client-payload: |
            {
              "component": "${{ env.COMPONENT_NAME }}",
              "image_tag": "${{ needs.determine-params.outputs.image_tag }}",
              "repo_name": "${{ needs.determine-params.outputs.repo_name }}",
              "source_repo": "${{ github.repository }}",
              "source_deployment_id": "${{ steps.create_deployment.outputs.deployment_id }}",
              "source_run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "pr_url": "${{ needs.determine-params.outputs.pr_url }}"
            }
      
      - name: Update Deployment Status
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ github.token }}
          deployment-id: ${{ steps.create_deployment.outputs.deployment_id }}
          state: "in_progress"
          description: "Deployment triggered in infrastructure repository"
  
  # Deploy to prod environment
  deploy-to-prod:
    name: Deploy to Production
    needs: determine-params
    if: needs.determine-params.outputs.environment == 'PROD'
    runs-on: ubuntu-latest
    environment:
      name: PROD
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Create GitHub Deployment
        id: create_deployment
        uses: chrnorm/deployment-action@v2
        with:
          token: ${{ github.token }}
          environment: PROD
          ref: ${{ needs.determine-params.outputs.ref }}
          description: 'Deployment of ${{ env.COMPONENT_NAME }} image ${{ needs.determine-params.outputs.image_tag }} to PROD'
          auto-merge: false
          payload: |
            {
              "image_tag": "${{ needs.determine-params.outputs.image_tag }}",
              "component": "${{ env.COMPONENT_NAME }}",
              "triggered_by": "${{ github.actor }}",
              "timestamp": "${{ github.event.repository.updated_at }}",
              "workflow_run_id": "${{ needs.determine-params.outputs.workflow_run_id }}"
            }

      - name: Update Deployment Status
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ github.token }}
          deployment-id: ${{ steps.create_deployment.outputs.deployment_id }}
          state: "pending"
          description: "Preparing to deploy"
      
      - name: Trigger Infrastructure Deployment
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.INFRA_REPO_TOKEN }}
          repository: ${{ env.INFRA_REPO }}
          event-type: new-image-prod
          client-payload: |
            {
              "component": "${{ env.COMPONENT_NAME }}",
              "image_tag": "${{ needs.determine-params.outputs.image_tag }}",
              "repo_name": "${{ needs.determine-params.outputs.repo_name }}",
              "source_repo": "${{ github.repository }}",
              "source_deployment_id": "${{ steps.create_deployment.outputs.deployment_id }}",
              "source_run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "pr_url": "${{ needs.determine-params.outputs.pr_url }}"
            }
      
      - name: Update Deployment Status
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ github.token }}
          deployment-id: ${{ steps.create_deployment.outputs.deployment_id }}
          state: "in_progress"
          description: "Deployment triggered in infrastructure repository"
